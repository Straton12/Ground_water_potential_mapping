<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hydrogeology | Kenya Water Resources Dashboard</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.0/chart.min.css" />
    <style>
        :root {
            /* Colors - Professional Dashboard Theme */
            --primary: #2c3e50;
            --primary-light: #34495e;
            --secondary: #3498db;
            --accent: #1abc9c;
            --success: #2ecc71;
            --warning: #f39c12;
            --danger: #e74c3c;
            --info: #9b59b6;
            --geology-purple: #8e44ad;
            --suitability-green: #27ae60;
            --rainfall-blue: #2980b9;

            --dark: #1a1a2e;
            --light: #f8f9fa;
            --gray: #6c757d;
            --gray-light: #e9ecef;
            --border: #dee2e6;

            /* Backgrounds */
            --bg-primary: #ffffff;
            --bg-secondary: #f8f9fa;
            --bg-sidebar: #2c3e50;
            --bg-card: #ffffff;

            /* Typography */
            --font-xs: 0.75rem;
            --font-sm: 0.875rem;
            --font-base: 0.9375rem;
            --font-md: 1rem;
            --font-lg: 1.125rem;
            --font-xl: 1.25rem;
            --font-2xl: 1.5rem;
            --font-3xl: 1.75rem;

            /* Spacing */
            --space-1: 0.25rem;
            --space-2: 0.5rem;
            --space-3: 0.75rem;
            --space-4: 1rem;
            --space-5: 1.25rem;
            --space-6: 1.5rem;
            --space-7: 1.75rem;
            --space-8: 2rem;
            --space-9: 2.5rem;
            --space-10: 3rem;

            /* Design Elements */
            --radius-sm: 0.25rem;
            --radius: 0.375rem;
            --radius-lg: 0.5rem;
            --radius-xl: 0.75rem;

            --shadow-sm: 0 1px 3px rgba(0, 0, 0, 0.1);
            --shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
            --shadow-md: 0 4px 12px rgba(0, 0, 0, 0.1);
            --shadow-lg: 0 8px 24px rgba(0, 0, 0, 0.1);

            --transition: all 0.2s ease;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
            font-size: var(--font-base);
            line-height: 1.5;
            color: var(--dark);
            background-color: var(--light);
            overflow-x: hidden;
        }

        .dashboard-container {
            display: grid;
            grid-template-columns: 280px 1fr;
            min-height: 100vh;
        }

        /* Sidebar */
        .sidebar {
            background: var(--bg-sidebar);
            color: white;
            padding: var(--space-6);
            position: fixed;
            width: 280px;
            height: 100vh;
            overflow-y: auto;
            z-index: 1000;
            box-shadow: var(--shadow-lg);
        }

        .sidebar-header {
            display: flex;
            align-items: center;
            gap: var(--space-3);
            margin-bottom: var(--space-8);
            padding-bottom: var(--space-4);
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .sidebar-header i {
            font-size: var(--font-2xl);
            color: var(--accent);
        }

        .sidebar-header h1 {
            font-size: var(--font-lg);
            font-weight: 600;
            line-height: 1.2;
        }

        .sidebar-nav {
            display: flex;
            flex-direction: column;
            gap: var(--space-2);
        }

        .nav-item {
            display: flex;
            align-items: center;
            gap: var(--space-3);
            padding: var(--space-3) var(--space-4);
            border-radius: var(--radius);
            color: rgba(255, 255, 255, 0.8);
            text-decoration: none;
            transition: var(--transition);
        }

        .nav-item:hover {
            background: rgba(255, 255, 255, 0.1);
            color: white;
        }

        .nav-item.active {
            background: var(--secondary);
            color: white;
            font-weight: 500;
        }

        .nav-item i {
            width: 20px;
            text-align: center;
        }

        .sidebar-section {
            margin-top: var(--space-8);
        }

        .sidebar-section h3 {
            font-size: var(--font-sm);
            font-weight: 600;
            color: rgba(255, 255, 255, 0.6);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: var(--space-3);
        }

        /* Main Content */
        .main-content {
            grid-column: 2;
            padding: var(--space-4);
            background: var(--bg-secondary);
        }

        /* Top Bar */
        .top-bar {
            background: var(--bg-primary);
            border-radius: var(--radius-lg);
            padding: var(--space-4) var(--space-6);
            margin-bottom: var(--space-4);
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: var(--shadow);
        }

        .page-title {
            display: flex;
            align-items: center;
            gap: var(--space-3);
        }

        .page-title h2 {
            font-size: var(--font-xl);
            font-weight: 600;
            color: var(--primary);
        }

        .page-title i {
            color: var(--secondary);
        }

        .toolbar {
            display: flex;
            align-items: center;
            gap: var(--space-3);
        }

        /* Content Cards */
        .content-card {
            background: var(--bg-card);
            border-radius: var(--radius-lg);
            padding: var(--space-5);
            box-shadow: var(--shadow);
            margin-bottom: var(--space-4);
            transition: var(--transition);
        }

        .content-card:hover {
            box-shadow: var(--shadow-md);
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: var(--space-4);
            padding-bottom: var(--space-3);
            border-bottom: 1px solid var(--border);
        }

        .card-header h3 {
            font-size: var(--font-lg);
            font-weight: 600;
            color: var(--primary);
            display: flex;
            align-items: center;
            gap: var(--space-3);
        }

        /* Potential Classes */
        .potential-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: var(--space-4);
            margin: var(--space-4) 0;
        }

        .potential-class {
            padding: var(--space-4);
            border-radius: var(--radius-lg);
            color: white;
            box-shadow: var(--shadow);
            transition: var(--transition);
        }

        .potential-class:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }

        .potential-class h4 {
            font-size: var(--font-md);
            margin-bottom: var(--space-2);
            font-weight: 600;
        }

        .potential-class p {
            font-size: var(--font-xs);
            opacity: 0.9;
            margin-bottom: var(--space-2);
            line-height: 1.4;
        }

        .class-percentage {
            font-size: var(--font-sm);
            font-weight: 600;
            opacity: 0.95;
        }

        .class-1 {
            background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
        }

        .class-2 {
            background: linear-gradient(135deg, #f39c12 0%, #d35400 100%);
        }

        .class-3 {
            background: linear-gradient(135deg, #f1c40f 0%, #f39c12 100%);
        }

        .class-4 {
            background: linear-gradient(135deg, #2ecc71 0%, #27ae60 100%);
        }

        .class-5 {
            background: linear-gradient(135deg, #3498db 0%, #2980b9 100%);
        }

        /* Insight Card */
        .insight-card {
            background: var(--bg-secondary);
            padding: var(--space-4);
            border-radius: var(--radius);
            border-left: 4px solid var(--secondary);
            margin: var(--space-4) 0;
        }

        .insight-card h4 {
            display: flex;
            align-items: center;
            gap: var(--space-3);
            font-size: var(--font-md);
            margin-bottom: var(--space-2);
            color: var(--dark);
        }

        .insight-card p {
            color: var(--gray);
            font-size: var(--font-sm);
            line-height: 1.5;
        }

        /* Geology Table */
        .data-table {
            width: 100%;
            border-collapse: collapse;
            margin: var(--space-4) 0;
            background: white;
            border-radius: var(--radius);
            overflow: hidden;
            box-shadow: var(--shadow);
            font-size: var(--font-sm);
        }

        .data-table th {
            background: var(--primary);
            color: white;
            padding: var(--space-3);
            text-align: left;
            font-weight: 600;
        }

        .data-table td {
            padding: var(--space-3);
            border-bottom: 1px solid var(--border);
        }

        .data-table tr:hover {
            background: var(--bg-secondary);
        }

        /* Badges */
        .badge {
            display: inline-block;
            padding: var(--space-1) var(--space-2);
            border-radius: var(--radius-sm);
            font-size: var(--font-xs);
            font-weight: 600;
        }

        .badge-success {
            background: #d4edda;
            color: #155724;
        }

        .badge-warning {
            background: #fff3cd;
            color: #856404;
        }

        .badge-danger {
            background: #f8d7da;
            color: #721c24;
        }

        .badge-info {
            background: #d1ecf1;
            color: #0c5460;
        }

        /* Layer Grid */
        .layer-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: var(--space-4);
            margin: var(--space-4) 0;
        }

        .layer-card {
            background: white;
            border-radius: var(--radius);
            padding: var(--space-4);
            box-shadow: var(--shadow);
            border: 1px solid var(--border);
            transition: var(--transition);
        }

        .layer-card:hover {
            transform: translateY(-2px);
            border-color: var(--secondary);
        }

        .layer-icon {
            font-size: var(--font-xl);
            color: var(--secondary);
            margin-bottom: var(--space-3);
        }

        .layer-card h4 {
            font-size: var(--font-md);
            margin-bottom: var(--space-2);
            color: var(--dark);
            font-weight: 600;
        }

        .layer-card p {
            color: var(--gray);
            font-size: var(--font-xs);
            margin-bottom: var(--space-2);
            line-height: 1.4;
        }

        .layer-weight {
            font-size: var(--font-sm);
            font-weight: 600;
            color: var(--primary);
        }

        /* AHP Grid */
        .ahp-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: var(--space-3);
            margin: var(--space-4) 0;
        }

        .ahp-item {
            background: rgba(52, 152, 219, 0.1);
            padding: var(--space-3);
            border-radius: var(--radius);
            text-align: center;
            border: 1px solid rgba(52, 152, 219, 0.2);
        }

        .ahp-weight {
            font-size: var(--font-md);
            font-weight: 700;
            color: var(--secondary);
            margin-bottom: var(--space-1);
        }

        .ahp-criteria {
            font-weight: 600;
            color: var(--primary);
            margin-bottom: var(--space-1);
            font-size: var(--font-sm);
        }

        .ahp-item p {
            color: var(--gray);
            font-size: var(--font-xs);
            line-height: 1.4;
        }

        /* Map Tabs */
        .map-tabs {
            display: flex;
            background: var(--bg-secondary);
            border-radius: var(--radius);
            padding: var(--space-1);
            margin: var(--space-4) 0;
        }

        .map-tab {
            flex: 1;
            padding: var(--space-2) var(--space-3);
            text-align: center;
            font-size: var(--font-sm);
            font-weight: 500;
            color: var(--gray);
            cursor: pointer;
            border-radius: calc(var(--radius) - var(--space-1));
            transition: var(--transition);
        }

        .map-tab:hover {
            background: var(--gray-light);
        }

        .map-tab.active {
            background: var(--secondary);
            color: white;
        }

        /* Map Container */
        .map-container {
            background: var(--bg-card);
            border-radius: var(--radius-lg);
            overflow: hidden;
            box-shadow: var(--shadow);
            height: 500px;
            position: relative;
            margin-bottom: var(--space-4);
        }

        #geology-map {
            width: 100%;
            height: 100%;
            border-radius: var(--radius-lg);
        }

        /* Map Controls */
        .map-controls {
            position: absolute;
            top: var(--space-4);
            right: var(--space-4);
            z-index: 1000;
            display: flex;
            flex-direction: column;
            gap: var(--space-2);
        }

        .map-controls .btn {
            width: 36px;
            height: 36px;
            border-radius: var(--radius);
            background: white;
            border: 1px solid var(--border);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: var(--transition);
            box-shadow: var(--shadow);
        }

        .map-controls .btn:hover {
            background: var(--secondary);
            color: white;
            border-color: var(--secondary);
        }

        /* Legend */
        .map-legend {
            position: absolute;
            bottom: var(--space-4);
            right: var(--space-4);
            background: white;
            border-radius: var(--radius);
            padding: var(--space-3);
            box-shadow: var(--shadow);
            z-index: 1000;
            max-width: 250px;
            max-height: 300px;
            overflow-y: auto;
        }

        .legend-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: var(--space-2);
        }

        .legend-header h5 {
            font-size: var(--font-sm);
            font-weight: 600;
            color: var(--primary);
        }

        .legend-content {
            display: flex;
            flex-direction: column;
            gap: var(--space-2);
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: var(--space-2);
            font-size: var(--font-xs);
        }

        .legend-color {
            width: 16px;
            height: 16px;
            border-radius: var(--radius-sm);
            flex-shrink: 0;
        }

        /* County Grid */
        .county-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: var(--space-4);
            margin: var(--space-4) 0;
        }

        .county-card {
            background: white;
            padding: var(--space-4);
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            border: 1px solid var(--border);
            transition: var(--transition);
            cursor: pointer;
        }

        .county-card:hover {
            transform: translateY(-2px);
            border-color: var(--secondary);
        }

        .county-card h4 {
            font-size: var(--font-md);
            margin-bottom: var(--space-2);
            color: var(--dark);
            font-weight: 600;
        }

        .county-potential {
            display: inline-block;
            padding: var(--space-1) var(--space-2);
            border-radius: var(--radius-sm);
            font-size: var(--font-xs);
            font-weight: 600;
            margin-bottom: var(--space-3);
        }

        .very-low {
            background: #fee2e2;
            color: #dc2626;
            border-left: 3px solid #dc2626;
        }

        .low {
            background: #fef3c7;
            color: #d97706;
            border-left: 3px solid #d97706;
        }

        .moderate-low {
            background: #fef9c3;
            color: #ca8a04;
            border-left: 3px solid #ca8a04;
        }

        .moderate {
            background: #d1fae5;
            color: #059669;
            border-left: 3px solid #059669;
        }

        .high {
            background: #dbeafe;
            color: #2563eb;
            border-left: 3px solid #2563eb;
        }

        .county-card p {
            color: var(--gray);
            font-size: var(--font-sm);
            margin-bottom: var(--space-3);
            line-height: 1.4;
        }

        .county-stats {
            display: flex;
            justify-content: space-between;
            font-size: var(--font-xs);
            color: var(--gray);
            border-top: 1px solid var(--border);
            padding-top: var(--space-2);
        }

        /* Button Styles */
        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: var(--space-2);
            padding: var(--space-2) var(--space-4);
            border-radius: var(--radius);
            font-size: var(--font-sm);
            font-weight: 500;
            border: none;
            cursor: pointer;
            transition: var(--transition);
            text-decoration: none;
        }

        .btn-primary {
            background: var(--secondary);
            color: white;
        }

        .btn-primary:hover {
            background: #2980b9;
            transform: translateY(-1px);
        }

        .btn-outline {
            background: transparent;
            border: 1px solid var(--border);
            color: var(--gray);
        }

        .btn-outline:hover {
            border-color: var(--secondary);
            color: var(--secondary);
        }

        /* Loading Overlay */
        .loading-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255, 255, 255, 0.9);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 2000;
            border-radius: var(--radius-lg);
        }

        .loading-spinner {
            width: 40px;
            height: 40px;
            border: 3px solid var(--gray-light);
            border-top: 3px solid var(--secondary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: var(--space-3);
        }

        .loading-text {
            font-size: var(--font-sm);
            color: var(--gray);
            font-weight: 500;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        /* Modal */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 10000;
            padding: var(--space-4);
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            border-radius: var(--radius-lg);
            padding: var(--space-5);
            max-width: 500px;
            width: 100%;
            max-height: 80vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: var(--space-4);
        }

        .modal-title {
            font-size: var(--font-lg);
            font-weight: 600;
            color: var(--dark);
            margin: 0;
        }

        .modal-close {
            background: none;
            border: none;
            font-size: var(--font-lg);
            cursor: pointer;
            color: var(--gray);
            padding: var(--space-1);
        }

        /* Responsive Design */
        @media (max-width: 1200px) {
            .dashboard-container {
                grid-template-columns: 1fr;
            }

            .sidebar {
                position: relative;
                width: 100%;
                height: auto;
            }

            .main-content {
                grid-column: 1;
            }
        }

        @media (max-width: 768px) {
            .potential-grid {
                grid-template-columns: repeat(2, 1fr);
            }

            .layer-grid {
                grid-template-columns: 1fr;
            }

            .ahp-grid {
                grid-template-columns: repeat(2, 1fr);
            }

            .county-grid {
                grid-template-columns: 1fr;
            }

            .top-bar {
                flex-direction: column;
                gap: var(--space-3);
                align-items: stretch;
            }

            .map-container {
                height: 400px;
            }
        }

        @media (max-width: 480px) {
            .potential-grid {
                grid-template-columns: 1fr;
            }

            .ahp-grid {
                grid-template-columns: 1fr;
            }
        }

        /* Custom Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: var(--bg-secondary);
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb {
            background: var(--gray);
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: var(--primary);
        }
    </style>
</head>

<body>
    <div class="dashboard-container">
        <!-- Sidebar -->
        <div class="sidebar">
            <div class="sidebar-header">
                <i class="fas fa-tint"></i>
                <div>
                    <h1>Kenya Water Resources</h1>
                    <p style="font-size: var(--font-xs); opacity: 0.7;">Dashboard v2.0</p>
                </div>
            </div>

            <nav class="sidebar-nav">
                <a href="index.html" class="nav-item">
                    <i class="fas fa-home"></i>
                    <span>Dashboard</span>
                </a>
                <a href="infrastructure.html" class="nav-item">
                    <i class="fas fa-network-wired"></i>
                    <span>Infrastructure</span>
                </a>
                <a href="hydrogeology.html" class="nav-item active">
                    <i class="fas fa-layer-group"></i>
                    <span>Hydrogeology</span>
                </a>
                <a href="analysis.html" class="nav-item">
                    <i class="fas fa-chart-line"></i>
                    <span>Analysis</span>
                </a>
                <a href="reports.html" class="nav-item">
                    <i class="fas fa-file-alt"></i>
                    <span>Reports</span>
                </a>
                <a href="methodology.html" class="nav-item">
                    <i class="fas fa-cogs"></i>
                    <span>Methodology</span>
                </a>
            </nav>

            <div class="sidebar-section">
                <h3>Quick Stats</h3>
                <div style="background: rgba(255,255,255,0.05); padding: var(--space-3); border-radius: var(--radius);">
                    <div style="display: flex; justify-content: space-between; margin-bottom: var(--space-2);">
                        <span style="font-size: var(--font-xs); opacity: 0.7;">Suitability Zones:</span>
                        <span style="font-weight: 600;" id="sidebar-suitability">7</span>
                    </div>
                    <div style="display: flex; justify-content: space-between; margin-bottom: var(--space-2);">
                        <span style="font-size: var(--font-xs); opacity: 0.7;">High Potential:</span>
                        <span style="font-weight: 600; color: var(--success);" id="sidebar-high-potential">25%</span>
                    </div>
                    <div style="display: flex; justify-content: space-between;">
                        <span style="font-size: var(--font-xs); opacity: 0.7;">Thematic Layers:</span>
                        <span style="font-weight: 600;" id="sidebar-layers">7</span>
                    </div>
                </div>
            </div>

            <div class="sidebar-section">
                <h3>Data Sources</h3>
                <div style="display: flex; flex-direction: column; gap: var(--space-2);">
                    <div style="display: flex; align-items: center; gap: var(--space-2); font-size: var(--font-xs);">
                        <i class="fas fa-check-circle" style="color: var(--success);"></i>
                        <span>Geological Survey</span>
                    </div>
                    <div style="display: flex; align-items: center; gap: var(--space-2); font-size: var(--font-xs);">
                        <i class="fas fa-check-circle" style="color: var(--success);"></i>
                        <span>NASA EarthData</span>
                    </div>
                    <div style="display: flex; align-items: center; gap: var(--space-2); font-size: var(--font-xs);">
                        <i class="fas fa-check-circle" style="color: var(--success);"></i>
                        <span>Kenya Met Dept</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Main Content -->
        <div class="main-content">
            <!-- Top Bar -->
            <div class="top-bar">
                <div class="page-title">
                    <i class="fas fa-layer-group"></i>
                    <div>
                        <h2>Hydrogeology Assessment</h2>
                        <p style="font-size: var(--font-sm); color: var(--gray); margin-top: 2px;">
                            Groundwater potential mapping and geological analysis
                        </p>
                    </div>
                </div>

                <div class="toolbar">
                    <div style="margin-right: var(--space-4);">
                        <p style="font-size: var(--font-xs); color: var(--gray);">Last updated:</p>
                        <p style="font-size: var(--font-sm); font-weight: 500;" id="last-updated">Today, 10:30 AM</p>
                    </div>
                    <button class="btn btn-primary" id="refresh-data">
                        <i class="fas fa-sync-alt"></i>
                        Refresh
                    </button>
                </div>
            </div>

            <!-- Groundwater Potential Section -->
            <div class="content-card">
                <div class="card-header">
                    <h3><i class="fas fa-water"></i> Groundwater Potential Classification</h3>
                </div>
                <p style="color: var(--gray); margin-bottom: var(--space-4);">
                    Five-tier classification based on integrated analysis of geological and environmental factors.
                </p>

                <div class="potential-grid" id="potential-grid">
                    <div class="loading-overlay" style="position: relative; height: 200px;">
                        <div class="loading-spinner"></div>
                        <div class="loading-text">Loading groundwater data...</div>
                    </div>
                </div>

                <div class="insight-card">
                    <h4><i class="fas fa-lightbulb"></i> Methodology</h4>
                    <p>Integrated analysis of geological formations, soil types, drainage patterns, rainfall, slope, and
                        lineament density using AHP weighting system.</p>
                </div>
            </div>

            <!-- Geological Formations -->
            <div class="content-card">
                <div class="card-header">
                    <h3><i class="fas fa-mountain"></i> Geological Formations</h3>
                </div>

                <div class="data-table" id="geology-table">
                    <div class="loading-overlay" style="position: relative; height: 300px;">
                        <div class="loading-spinner"></div>
                        <div class="loading-text">Loading geology data...</div>
                    </div>
                </div>

                <div
                    style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: var(--space-4); margin-top: var(--space-4);">
                    <div class="insight-card">
                        <h4><i class="fas fa-exclamation-triangle"></i> Key Insight</h4>
                        <p id="geology-insight">Loading...</p>
                    </div>

                    <div class="insight-card">
                        <h4><i class="fas fa-bullseye"></i> Strategy</h4>
                        <p>Targeted drilling in high-potential areas while avoiding costly failures in low-potential
                            zones.</p>
                    </div>
                </div>
            </div>

            <!-- Thematic Layers -->
            <div class="content-card">
                <div class="card-header">
                    <h3><i class="fas fa-layer-group"></i> Thematic Layer Analysis</h3>
                </div>
                <p style="color: var(--gray); margin-bottom: var(--space-4);">
                    Seven key parameters integrated for groundwater assessment
                </p>

                <div class="layer-grid" id="layer-grid">
                    <div class="loading-overlay" style="position: relative; height: 300px;">
                        <div class="loading-spinner"></div>
                        <div class="loading-text">Loading thematic layers...</div>
                    </div>
                </div>
            </div>

            <!-- AHP Weighting -->
            <div class="content-card"
                style="background: linear-gradient(135deg, #2c3e50 0%, #1a252f 100%); color: white;">
                <div class="card-header" style="border-bottom-color: rgba(255,255,255,0.2);">
                    <h3 style="color: white;"><i class="fas fa-balance-scale"></i> AHP Weighting</h3>
                </div>
                <p style="color: rgba(255,255,255,0.8); margin-bottom: var(--space-4);">
                    Relative importance of thematic layers in groundwater potential assessment
                </p>

                <div class="ahp-grid" id="ahp-grid">
                    <div class="loading-overlay"
                        style="position: relative; height: 200px; background: rgba(255,255,255,0.1);">
                        <div class="loading-spinner" style="border-top-color: white;"></div>
                        <div class="loading-text" style="color: white;">Loading AHP weights...</div>
                    </div>
                </div>

                <div style="text-align: center; margin-top: var(--space-4);">
                    <a href="methodology.html#ahp" class="btn"
                        style="background: rgba(255,255,255,0.1); color: white; border: 1px solid rgba(255,255,255,0.3);">
                        <i class="fas fa-table"></i>
                        View Full Matrix
                    </a>
                </div>
            </div>

            <!-- Interactive Map -->
            <div class="content-card">
                <div class="card-header">
                    <h3><i class="fas fa-map-marked-alt"></i> Groundwater Potential Map</h3>
                </div>

                <div class="map-tabs">
                    <div class="map-tab active" data-layer="groundwater">Groundwater</div>
                    <div class="map-tab" data-layer="geology">Geology</div>
                    <div class="map-tab" data-layer="rainfall">Rainfall</div>
                    <div class="map-tab" data-layer="drainage">Drainage</div>
                    <div class="map-tab" data-layer="landuse">Land Use</div>
                </div>

                <div class="map-container">
                    <div id="geology-map"></div>

                    <div class="loading-overlay" id="map-loading">
                        <div class="loading-spinner"></div>
                        <div class="loading-text">Initializing map...</div>
                    </div>

                    <!-- Map Controls -->
                    <div class="map-controls">
                        <button class="btn" id="reset-view" title="Reset View">
                            <i class="fas fa-globe-africa"></i>
                        </button>
                        <button class="btn" id="locate-me" title="My Location">
                            <i class="fas fa-location-crosshairs"></i>
                        </button>
                        <button class="btn" id="export-map" title="Export Map">
                            <i class="fas fa-download"></i>
                        </button>
                        <button class="btn" id="fullscreen" title="Full Screen">
                            <i class="fas fa-expand"></i>
                        </button>
                    </div>

                    <!-- Legend -->
                    <div class="map-legend" id="map-legend">
                        <div class="legend-header">
                            <h5>Groundwater Potential</h5>
                            <button class="btn btn-outline" style="padding: 2px 8px; font-size: 11px;"
                                id="toggle-legend">Hide</button>
                        </div>
                        <div class="legend-content" id="legend-content">
                            <!-- Legend items will be populated dynamically -->
                        </div>
                    </div>
                </div>
            </div>

            <!-- County Analysis -->
            <div class="content-card">
                <div class="card-header">
                    <h3><i class="fas fa-flag"></i> County Analysis</h3>
                </div>
                <p style="color: var(--gray); margin-bottom: var(--space-4);">
                    Groundwater potential assessment for ASAL counties
                </p>

                <div class="county-grid" id="county-grid">
                    <div class="loading-overlay" style="position: relative; height: 400px;">
                        <div class="loading-spinner"></div>
                        <div class="loading-text">Loading county data...</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- County Details Modal -->
    <div id="countyModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title" id="modalCountyTitle"></h3>
                <button class="modal-close" onclick="closeCountyModal()">&times;</button>
            </div>

            <div style="margin-bottom: var(--space-4);">
                <div style="display: flex; align-items: center; gap: var(--space-3); margin-bottom: var(--space-3);">
                    <span style="font-weight: 600; font-size: var(--font-sm);">Potential:</span>
                    <span id="modalCountyPotential"
                        style="padding: var(--space-1) var(--space-3); border-radius: var(--radius-sm); font-size: var(--font-xs); font-weight: 600;"></span>
                </div>

                <div
                    style="display: grid; grid-template-columns: repeat(2, 1fr); gap: var(--space-3); margin-bottom: var(--space-3);">
                    <div
                        style="background: var(--bg-secondary); padding: var(--space-3); border-radius: var(--radius);">
                        <div style="font-size: var(--font-xs); color: var(--gray); margin-bottom: var(--space-1);">Water
                            Points</div>
                        <div style="font-weight: 700; font-size: var(--font-sm);" id="modalCountyPoints"></div>
                    </div>
                    <div
                        style="background: var(--bg-secondary); padding: var(--space-3); border-radius: var(--radius);">
                        <div style="font-size: var(--font-xs); color: var(--gray); margin-bottom: var(--space-1);">
                            Functional Rate</div>
                        <div style="font-weight: 700; font-size: var(--font-sm); color: var(--success);"
                            id="modalCountyFunctional"></div>
                    </div>
                </div>

                <div style="background: var(--bg-secondary); padding: var(--space-3); border-radius: var(--radius);">
                    <div style="font-size: var(--font-xs); color: var(--gray); margin-bottom: var(--space-1);">
                        Description</div>
                    <div style="font-size: var(--font-sm); line-height: 1.4;" id="modalCountyDesc"></div>
                </div>
            </div>

            <div style="display: flex; gap: var(--space-3);">
                <button onclick="downloadCountyReport()" class="btn btn-primary" style="flex: 1;">
                    <i class="fas fa-download"></i> Download Report
                </button>
                <button onclick="closeCountyModal()" class="btn btn-outline" style="flex: 1;">
                    Close
                </button>
            </div>
        </div>
    </div>

    <!-- JavaScript Libraries -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.js"></script>

    <script>
        // Hydrogeology Dashboard State
        const HydrogeologyDashboard = {
            suitabilityData: [],
            countiesData: [],
            waterPointsData: [],
            thematicLayers: {},
            ahpWeights: {},
            map: null,
            currentLayer: 'groundwater',
            countyStats: {},
            layers: {
                suitability: null,
                counties: null,
                currentBasemap: 'osm'
            },
            basemaps: {
                osm: L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: '© OpenStreetMap contributors',
                    maxZoom: 19
                }),
                satellite: L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
                    attribution: '© Esri, Maxar, Earthstar Geographics',
                    maxZoom: 19
                }),
                topo: L.tileLayer('https://{s}.tile.opentopomap.org/{z}/{x}/{y}.png', {
                    attribution: '© OpenTopoMap',
                    maxZoom: 17
                }),
                dark: L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
                    attribution: '© CARTO',
                    maxZoom: 19
                })
            },
            kenyaBounds: [[-4.9, 33.8], [5.0, 42.0]]
        };

        // Suitability color mapping
        const SuitabilityColors = {
            1: '#e74c3c',  // Very Low
            2: '#f39c12',  // Low
            3: '#f1c40f',  // Moderately Low
            4: '#2ecc71',  // Moderate
            5: '#3498db',  // Moderately High
            6: '#2980b9',  // High
            7: '#8e44ad'   // Very High
        };

        // Suitability labels
        const SuitabilityLabels = {
            1: 'Very Low',
            2: 'Low',
            3: 'Moderately Low',
            4: 'Moderate',
            5: 'Moderately High',
            6: 'High',
            7: 'Very High'
        };

        // Initialize Application
        document.addEventListener('DOMContentLoaded', async () => {
            try {
                await initializeDashboard();
                setupEventListeners();
                updateSidebarStats();
            } catch (error) {
                console.error('Failed to initialize dashboard:', error);
                showError('Failed to load hydrogeology data. Please refresh the page.');
            }
        });

        // Initialize Dashboard
        async function initializeDashboard() {
            updateLoadingText('Initializing hydrogeology dashboard...');

            // Initialize map
            initializeMap();

            // Load all data
            await Promise.all([
                loadSuitabilityData(),
                loadCountiesData(),
                loadWaterPointsData()
            ]);

            // Update UI components
            updatePotentialGrid();
            updateGeologyTable();
            updateThematicLayers();
            updateAHPGrid();
            updateCountyGrid();

            // Hide loading overlay
            setTimeout(() => {
                document.getElementById('map-loading').style.opacity = '0';
                setTimeout(() => {
                    document.getElementById('map-loading').style.display = 'none';
                }, 300);
            }, 500);
        }

        // Initialize Map
        function initializeMap() {
            HydrogeologyDashboard.map = L.map('geology-map', {
                center: [0.5, 37.8],
                zoom: 6,
                minZoom: 5,
                maxZoom: 18,
                maxBounds: HydrogeologyDashboard.kenyaBounds,
                maxBoundsViscosity: 1.0
            });

            // Add default basemap
            HydrogeologyDashboard.basemaps.osm.addTo(HydrogeologyDashboard.map);

            // Add scale control
            L.control.scale({ imperial: false, position: 'bottomleft' }).addTo(HydrogeologyDashboard.map);

            // Add geocoder
            L.Control.geocoder({
                defaultMarkGeocode: false,
                position: 'topleft',
                placeholder: 'Search location...'
            })
                .on('markgeocode', (e) => {
                    HydrogeologyDashboard.map.fitBounds(e.geocode.bbox);
                })
                .addTo(HydrogeologyDashboard.map);
        }

        // Convert ESRI JSON to GeoJSON
        function esriToGeoJSON(esriJson) {
            if (!esriJson || !esriJson.features) {
                console.error('Invalid ESRI JSON format');
                return { type: 'FeatureCollection', features: [] };
            }

            const features = esriJson.features.map(feature => {
                // Handle ESRI geometry format
                let geometry = null;
                if (feature.geometry) {
                    if (feature.geometry.rings) {
                        // Polygon geometry
                        geometry = {
                            type: 'Polygon',
                            coordinates: feature.geometry.rings
                        };
                    } else if (feature.geometry.x !== undefined && feature.geometry.y !== undefined) {
                        // Point geometry (coordinates are swapped in ESRI JSON)
                        geometry = {
                            type: 'Point',
                            coordinates: [feature.geometry.x, feature.geometry.y]
                        };
                    } else if (feature.geometry.paths) {
                        // Polyline geometry
                        geometry = {
                            type: 'LineString',
                            coordinates: feature.geometry.paths[0]
                        };
                    }
                }

                return {
                    type: 'Feature',
                    properties: feature.attributes || {},
                    geometry: geometry
                };
            });

            return {
                type: 'FeatureCollection',
                features: features
            };
        }

        // Load suitability data
        async function loadSuitabilityData() {
            updateLoadingText('Loading suitability data...');

            try {
                const paths = [
                    'data/Suitable_json.json',
                    'Suitable_json.json',
                    'data/Suitable.json',
                    'Suitable.json'
                ];

                let data = null;
                for (const path of paths) {
                    try {
                        const response = await fetch(path);
                        if (response.ok) {
                            data = await response.json();
                            console.log(`Loaded suitability data from: ${path}`);
                            break;
                        }
                    } catch (e) {
                        console.log(`Failed to load from ${path}:`, e.message);
                        continue;
                    }
                }

                if (data) {
                    // Convert ESRI JSON to GeoJSON
                    const geoJsonData = esriToGeoJSON(data);
                    HydrogeologyDashboard.suitabilityData = geoJsonData.features || [];

                    // Add suitability layer to map
                    addSuitabilityLayer();

                    // Analyze suitability distribution
                    analyzeSuitabilityData();
                } else {
                    console.log('No suitability data found');
                    createFallbackSuitabilityData();
                }

            } catch (error) {
                console.error('Error loading suitability data:', error);
                createFallbackSuitabilityData();
            }
        }

        // Create fallback suitability data
        function createFallbackSuitabilityData() {
            const fallbackData = [
                { gridcode: 1, area_percentage: 18, description: 'Minimal chance of accessing underground water' },
                { gridcode: 2, area_percentage: 22, description: 'Limited availability requiring deeper drilling' },
                { gridcode: 3, area_percentage: 20, description: 'Slight improvement but uncertain yields' },
                { gridcode: 4, area_percentage: 25, description: 'Fairly reliable groundwater' },
                { gridcode: 5, area_percentage: 15, description: 'High likelihood with viable yields' }
            ];

            HydrogeologyDashboard.suitabilityData = fallbackData.map(item => ({
                properties: item,
                geometry: null
            }));

            console.log('Created fallback suitability data');
            analyzeSuitabilityData();
        }

        // Analyze suitability data
        function analyzeSuitabilityData() {
            const suitabilityStats = {
                totalAreas: 0,
                byClass: {}
            };

            HydrogeologyDashboard.suitabilityData.forEach(feature => {
                const props = feature.properties || {};
                const suitability = props.gridcode || 0;

                if (!suitabilityStats.byClass[suitability]) {
                    suitabilityStats.byClass[suitability] = {
                        count: 0,
                        totalArea: 0
                    };
                }

                suitabilityStats.byClass[suitability].count++;
                suitabilityStats.byClass[suitability].totalArea++;
                suitabilityStats.totalAreas++;
            });

            // Calculate percentages
            Object.keys(suitabilityStats.byClass).forEach(suitability => {
                const data = suitabilityStats.byClass[suitability];
                data.percentage = Math.round((data.totalArea / suitabilityStats.totalAreas) * 100);
            });

            HydrogeologyDashboard.suitabilityStats = suitabilityStats;

            // Update UI
            updatePotentialGrid();
            updateLegend();
        }

        // Load counties data
        async function loadCountiesData() {
            try {
                const paths = [
                    'data/Asal_counties.json',
                    'Asal_counties.json'
                ];

                let data = null;
                for (const path of paths) {
                    try {
                        const response = await fetch(path);
                        if (response.ok) {
                            data = await response.json();
                            console.log(`Loaded counties from: ${path}`);
                            break;
                        }
                    } catch (e) {
                        continue;
                    }
                }

                if (data) {
                    // Convert ESRI JSON to GeoJSON
                    const geoJsonData = esriToGeoJSON(data);
                    HydrogeologyDashboard.countiesData = geoJsonData.features || [];
                    console.log(`Loaded ${HydrogeologyDashboard.countiesData.length} county features`);

                    // Add counties layer to map
                    addCountiesLayer();
                } else {
                    console.log('No counties data found');
                }

            } catch (error) {
                console.error('Error loading counties data:', error);
            }
        }

        // Load water points data for county analysis
        async function loadWaterPointsData() {
            try {
                const paths = [
                    'data/Asal_water_points.json',
                    'Asal_water_points.json'
                ];

                let data = null;
                for (const path of paths) {
                    try {
                        const response = await fetch(path);
                        if (response.ok) {
                            data = await response.json();
                            console.log(`Loaded water points from: ${path}`);
                            break;
                        }
                    } catch (e) {
                        continue;
                    }
                }

                if (data) {
                    // Convert ESRI JSON to GeoJSON
                    const geoJsonData = esriToGeoJSON(data);
                    HydrogeologyDashboard.waterPointsData = geoJsonData.features || [];
                    console.log(`Loaded ${HydrogeologyDashboard.waterPointsData.length} water points`);

                    // Analyze county statistics
                    analyzeCountyStats();
                } else {
                    console.log('No water points data found');
                }

            } catch (error) {
                console.error('Error loading water points data:', error);
            }
        }

        // Analyze county statistics
        function analyzeCountyStats() {
            HydrogeologyDashboard.countyStats = {};

            HydrogeologyDashboard.waterPointsData.forEach(point => {
                const props = point.properties || {};
                const county = props.clean_adm1 || props.COUNTY || props.county || 'Unknown';

                if (!HydrogeologyDashboard.countyStats[county]) {
                    HydrogeologyDashboard.countyStats[county] = {
                        total: 0,
                        functional: 0,
                        nonFunctional: 0,
                        needsRepair: 0,
                        unknown: 0
                    };
                }

                HydrogeologyDashboard.countyStats[county].total++;

                const status = props.status_cle || props.STATUS || props.status || 'Unknown';
                const lowerStatus = status.toLowerCase();

                if (lowerStatus.includes('functional') && !lowerStatus.includes('non')) {
                    HydrogeologyDashboard.countyStats[county].functional++;
                } else if (lowerStatus.includes('non-functional') || lowerStatus.includes('abandoned')) {
                    HydrogeologyDashboard.countyStats[county].nonFunctional++;
                } else if (lowerStatus.includes('repair') || lowerStatus.includes('maintenance')) {
                    HydrogeologyDashboard.countyStats[county].needsRepair++;
                } else {
                    HydrogeologyDashboard.countyStats[county].unknown++;
                }
            });

            // Update county grid
            updateCountyGrid();
        }

        // Add suitability layer to map
        function addSuitabilityLayer() {
            if (!HydrogeologyDashboard.map) return;

            // Clear existing layers
            if (HydrogeologyDashboard.layers.suitability) {
                HydrogeologyDashboard.map.removeLayer(HydrogeologyDashboard.layers.suitability);
            }

            // Create GeoJSON layer from features with geometry
            const featuresWithGeometry = HydrogeologyDashboard.suitabilityData.filter(f => f.geometry);

            if (featuresWithGeometry.length === 0) {
                console.log('No geometry data available for suitability layer');
                return;
            }

            const geoJsonData = {
                type: 'FeatureCollection',
                features: featuresWithGeometry
            };

            HydrogeologyDashboard.layers.suitability = L.geoJSON(geoJsonData, {
                style: function (feature) {
                    const suitability = feature.properties?.gridcode || 1;
                    const color = SuitabilityColors[suitability] || SuitabilityColors[1];

                    return {
                        fillColor: color,
                        weight: 0.5,
                        opacity: 0.3,
                        color: color,
                        fillOpacity: 0.5
                    };
                },
                onEachFeature: function (feature, layer) {
                    const props = feature.properties || {};
                    const suitability = props.gridcode || 1;
                    const label = SuitabilityLabels[suitability] || 'Unknown';

                    layer.bindPopup(`
                        <div style="font-size: 12px; font-family: -apple-system, sans-serif;">
                            <div style="background: ${SuitabilityColors[suitability]}; color: white; padding: 8px; margin: -10px -10px 10px -10px; border-radius: 4px 4px 0 0;">
                                <strong>Groundwater Potential</strong>
                            </div>
                            <div style="padding: 4px 0;">
                                <div style="display: grid; grid-template-columns: 100px 1fr; gap: 4px; margin-bottom: 4px;">
                                    <strong>Class:</strong>
                                    <span style="color: ${SuitabilityColors[suitability]}">${suitability}/7</span>
                                </div>
                                <div style="display: grid; grid-template-columns: 100px 1fr; gap: 4px; margin-bottom: 4px;">
                                    <strong>Rating:</strong>
                                    <span>${label}</span>
                                </div>
                                <div>
                                    <strong>Description:</strong><br>
                                    <small>${getSuitabilityDescription(suitability)}</small>
                                </div>
                            </div>
                        </div>
                    `);
                }
            }).addTo(HydrogeologyDashboard.map);
        }

        // Add counties layer to map
        function addCountiesLayer() {
            if (!HydrogeologyDashboard.map || !HydrogeologyDashboard.countiesData.length) return;

            const featuresWithGeometry = HydrogeologyDashboard.countiesData.filter(f => f.geometry);

            if (featuresWithGeometry.length === 0) {
                console.log('No geometry data available for counties layer');
                return;
            }

            const geoJsonData = {
                type: 'FeatureCollection',
                features: featuresWithGeometry
            };

            HydrogeologyDashboard.layers.counties = L.geoJSON(geoJsonData, {
                style: {
                    color: '#1a5fb4',
                    weight: 2,
                    opacity: 0.8,
                    fillColor: '#1a5fb4',
                    fillOpacity: 0.05
                },
                onEachFeature: function (feature, layer) {
                    const props = feature.properties || {};
                    const countyName = props.ADM1_EN || props.county || 'Unknown';

                    layer.bindTooltip(countyName, {
                        permanent: false,
                        direction: 'center',
                        className: 'county-tooltip'
                    });

                    layer.on('mouseover', (e) => {
                        e.target.setStyle({
                            fillOpacity: 0.2,
                            weight: 3
                        });
                    });

                    layer.on('mouseout', (e) => {
                        e.target.setStyle({
                            fillOpacity: 0.05,
                            weight: 2
                        });
                        e.target.closeTooltip();
                    });

                    layer.on('click', () => {
                        showCountyDetails(countyName);
                    });
                }
            }).addTo(HydrogeologyDashboard.map);
        }

        // Get suitability description
        function getSuitabilityDescription(suitability) {
            const descriptions = {
                1: 'Very low potential for groundwater development',
                2: 'Low potential, requires careful assessment',
                3: 'Moderately low potential with uncertain yields',
                4: 'Moderate potential for community water supply',
                5: 'Moderately high potential with viable yields',
                6: 'High potential suitable for development',
                7: 'Very high potential for water projects'
            };
            return descriptions[suitability] || 'Groundwater potential area';
        }

        // Update potential grid
        function updatePotentialGrid() {
            const grid = document.getElementById('potential-grid');
            const stats = HydrogeologyDashboard.suitabilityStats;

            if (!stats || !stats.byClass) {
                grid.innerHTML = '<div class="loading-overlay" style="position: relative; height: 200px;"><div class="loading-spinner"></div><p>Analyzing data...</p></div>';
                return;
            }

            const classes = [1, 2, 3, 4, 5]; // We'll use 5 classes
            const classDescriptions = {
                1: 'Minimal chance of accessing underground water in crystalline bedrock areas.',
                2: 'Limited availability requiring deeper drilling in fracture zones.',
                3: 'Slight improvement but uncertain yields requiring careful assessment.',
                4: 'Fairly reliable groundwater suitable for basic community use.',
                5: 'High likelihood with viable yields for borehole development.'
            };

            const html = classes.map(suitability => {
                const data = stats.byClass[suitability] || { percentage: 0 };
                const percentage = data.percentage || 0;

                return `
                    <div class="potential-class class-${suitability}">
                        <h4>${suitability}. ${SuitabilityLabels[suitability] || 'Unknown'}</h4>
                        <p>${classDescriptions[suitability] || 'No description available.'}</p>
                        <div class="class-percentage">${percentage}% of ASAL area</div>
                    </div>
                `;
            }).join('');

            grid.innerHTML = html;
        }

        // Update geology table
        function updateGeologyTable() {
            const table = document.getElementById('geology-table');
            const insight = document.getElementById('geology-insight');

            const geologyData = [
                { formation: 'Quaternary', rock: 'Sand, gravel', potential: 'High', suitability: 'Optimal for development' },
                { formation: 'Cretaceous', rock: 'Chalk, shale', potential: 'Mod-High', suitability: 'Suitable for supply' },
                { formation: 'Jurassic', rock: 'Sandstone, limestone', potential: 'Moderate', suitability: 'Medium-scale projects' },
                { formation: 'Triassic', rock: 'Sandstone, clay', potential: 'Low', suitability: 'Challenging' },
                { formation: 'Precambrian', rock: 'Granite, gneiss', potential: 'Very Low', suitability: 'Difficult' }
            ];

            const html = `
                <table style="width: 100%; border-collapse: collapse;">
                    <thead>
                        <tr>
                            <th>Formation</th>
                            <th>Rock Type</th>
                            <th>Potential</th>
                            <th>Suitability</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${geologyData.map(item => `
                            <tr>
                                <td style="padding: var(--space-3); border-bottom: 1px solid var(--border);"><strong>${item.formation}</strong></td>
                                <td style="padding: var(--space-3); border-bottom: 1px solid var(--border);">${item.rock}</td>
                                <td style="padding: var(--space-3); border-bottom: 1px solid var(--border);">
                                    <span class="badge ${getPotentialBadgeClass(item.potential)}">${item.potential}</span>
                                </td>
                                <td style="padding: var(--space-3); border-bottom: 1px solid var(--border);">${item.suitability}</td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;

            table.innerHTML = html;

            // Update insight
            const precambrianPercentage = HydrogeologyDashboard.suitabilityStats?.byClass?.[1]?.percentage || 18;
            insight.textContent = `Precambrian crystalline rocks dominate many ASAL counties (${precambrianPercentage}% very low potential), limiting conventional groundwater development.`;
        }

        // Get badge class for potential
        function getPotentialBadgeClass(potential) {
            const classes = {
                'High': 'badge-success',
                'Mod-High': 'badge-info',
                'Moderate': 'badge-warning',
                'Low': 'badge-warning',
                'Very Low': 'badge-danger'
            };
            return classes[potential] || 'badge-warning';
        }

        // Update thematic layers grid
        function updateThematicLayers() {
            const grid = document.getElementById('layer-grid');

            const layers = [
                {
                    icon: 'fa-cloud-rain',
                    name: 'Rainfall',
                    description: 'Most dominant factor. Primary driver of groundwater recharge.',
                    weight: '38.0%'
                },
                {
                    icon: 'fa-gem',
                    name: 'Geology',
                    description: 'Determines subsurface permeability. Influences water storage.',
                    weight: '24.7%'
                },
                {
                    icon: 'fa-chart-area',
                    name: 'Slope',
                    description: 'Influences infiltration time. Gentle slopes favor recharge.',
                    weight: '13.1%'
                },
                {
                    icon: 'fa-water',
                    name: 'Drainage Density',
                    description: 'Inverse proxy for infiltration. Low density indicates high potential.',
                    weight: '8.9%'
                },
                {
                    icon: 'fa-mountain',
                    name: 'Land Use',
                    description: 'Surface characteristics affecting infiltration rates.',
                    weight: '6.6%'
                },
                {
                    icon: 'fa-road',
                    name: 'Lineament Density',
                    description: 'Fracture networks controlling water movement.',
                    weight: '5.0%'
                },
                {
                    icon: 'fa-seedling',
                    name: 'Soil Type',
                    description: 'Influences subsurface infiltration capacity.',
                    weight: '3.7%'
                }
            ];

            const html = layers.map((layer, index) => `
                <div class="layer-card">
                    <div class="layer-icon">
                        <i class="fas ${layer.icon}"></i>
                    </div>
                    <h4>${layer.name}</h4>
                    <p>${layer.description}</p>
                    <div class="layer-weight">Weight: ${layer.weight}</div>
                </div>
            `).join('');

            grid.innerHTML = html;
        }

        // Update AHP grid
        function updateAHPGrid() {
            const grid = document.getElementById('ahp-grid');

            const ahpWeights = [
                { criteria: 'Rainfall', weight: '38.0%', description: 'Primary recharge driver' },
                { criteria: 'Geology', weight: '24.7%', description: 'Subsurface permeability' },
                { criteria: 'Slope', weight: '13.1%', description: 'Infiltration time' },
                { criteria: 'Drainage', weight: '8.9%', description: 'Infiltration proxy' },
                { criteria: 'Land Use', weight: '6.6%', description: 'Surface characteristics' },
                { criteria: 'Lineaments', weight: '5.0%', description: 'Fracture networks' },
                { criteria: 'Soil Type', weight: '3.7%', description: 'Infiltration capacity' }
            ];

            const html = ahpWeights.map((item, index) => `
                <div class="ahp-item">
                    <div class="ahp-weight">${item.weight}</div>
                    <div class="ahp-criteria">${item.criteria}</div>
                    <p>${item.description}</p>
                </div>
            `).join('');

            grid.innerHTML = html;
        }

        // Update legend
        function updateLegend() {
            const legendContent = document.getElementById('legend-content');

            const legendHtml = Object.entries(SuitabilityColors)
                .filter(([key]) => key <= 5) // Only show first 5 classes
                .map(([suitability, color]) => `
                    <div class="legend-item">
                        <span class="legend-color" style="background: ${color};"></span>
                        <span>${SuitabilityLabels[suitability] || 'Unknown'}</span>
                    </div>
                `).join('');

            legendContent.innerHTML = legendHtml;
        }

        // Update county grid
        function updateCountyGrid() {
            const grid = document.getElementById('county-grid');

            // Get top counties with data
            const counties = Object.entries(HydrogeologyDashboard.countyStats || {})
                .filter(([county]) => county !== 'Unknown')
                .sort((a, b) => b[1].total - a[1].total)
                .slice(0, 6); // Show top 6 counties

            if (counties.length === 0) {
                // Use sample data if no real data
                const sampleCounties = [
                    {
                        name: 'Turkana',
                        potential: 'Low',
                        potentialClass: 'low',
                        description: 'Precambrian basement rocks with limited storage.',
                        stats: '71,597 km² | High: 15%'
                    },
                    {
                        name: 'Marsabit',
                        potential: 'Very Low',
                        potentialClass: 'very-low',
                        description: 'Volcanic rocks with limited permeability.',
                        stats: '66,923 km² | High: 8%'
                    },
                    {
                        name: 'Garissa',
                        potential: 'Moderate',
                        potentialClass: 'moderate',
                        description: 'Sedimentary formations with fair potential.',
                        stats: '45,720 km² | High: 25%'
                    },
                    {
                        name: 'Wajir',
                        potential: 'Low',
                        potentialClass: 'low',
                        description: 'Limited rainfall and crystalline bedrock.',
                        stats: '56,686 km² | High: 12%'
                    },
                    {
                        name: 'Mandera',
                        potential: 'Very Low',
                        potentialClass: 'very-low',
                        description: 'Extreme aridity and basement complex.',
                        stats: '25,797 km² | High: 5%'
                    },
                    {
                        name: 'Isiolo',
                        potential: 'Mod Low',
                        potentialClass: 'moderate-low',
                        description: 'Mixed geology with limited potential.',
                        stats: '25,336 km² | High: 18%'
                    }
                ];

                const html = sampleCounties.map((county, index) => `
                    <div class="county-card" data-county="${county.name}" onclick="showCountyDetails('${county.name}')">
                        <h4>${county.name}</h4>
                        <div class="county-potential ${county.potentialClass}">${county.potential}</div>
                        <p>${county.description}</p>
                        <div class="county-stats">
                            <span>${county.stats}</span>
                        </div>
                    </div>
                `).join('');

                grid.innerHTML = html;
            } else {
                // Use real data
                const html = counties.map(([countyName, stats], index) => {
                    const functionalRate = stats.total > 0 ?
                        Math.round((stats.functional / stats.total) * 100) : 0;

                    // Determine potential based on functional rate
                    let potential = 'Low';
                    let potentialClass = 'low';

                    if (functionalRate >= 70) {
                        potential = 'High';
                        potentialClass = 'high';
                    } else if (functionalRate >= 50) {
                        potential = 'Moderate';
                        potentialClass = 'moderate';
                    } else if (functionalRate >= 30) {
                        potential = 'Mod Low';
                        potentialClass = 'moderate-low';
                    } else {
                        potential = 'Low';
                        potentialClass = 'low';
                    }

                    const description = `${countyName} County has ${stats.total} water points with ${functionalRate}% functional rate.`;

                    return `
                        <div class="county-card" data-county="${countyName}" onclick="showCountyDetails('${countyName}')">
                            <h4>${countyName}</h4>
                            <div class="county-potential ${potentialClass}">${potential}</div>
                            <p>${description}</p>
                            <div class="county-stats">
                                <span>Points: ${stats.total}</span>
                                <span>Functional: ${functionalRate}%</span>
                            </div>
                        </div>
                    `;
                }).join('');

                grid.innerHTML = html;
            }
        }

        // Show county details modal
        function showCountyDetails(countyName) {
            const stats = HydrogeologyDashboard.countyStats?.[countyName];

            document.getElementById('modalCountyTitle').textContent = `${countyName} County`;

            if (stats) {
                const functionalRate = stats.total > 0 ?
                    Math.round((stats.functional / stats.total) * 100) : 0;

                // Determine potential
                let potential = 'Low';
                let potentialClass = 'low';

                if (functionalRate >= 70) {
                    potential = 'High';
                    potentialClass = 'high';
                } else if (functionalRate >= 50) {
                    potential = 'Moderate';
                    potentialClass = 'moderate';
                } else if (functionalRate >= 30) {
                    potential = 'Mod Low';
                    potentialClass = 'moderate-low';
                } else {
                    potential = 'Low';
                    potentialClass = 'low';
                }

                document.getElementById('modalCountyPotential').textContent = potential;
                document.getElementById('modalCountyPotential').className = `county-potential ${potentialClass}`;
                document.getElementById('modalCountyPoints').textContent = stats.total.toLocaleString();
                document.getElementById('modalCountyFunctional').textContent = `${functionalRate}%`;
                document.getElementById('modalCountyDesc').textContent =
                    `${countyName} County has ${stats.total} water points, with ${stats.functional} functional (${functionalRate}%), ${stats.nonFunctional} non-functional, and ${stats.needsRepair} needing repair.`;
            } else {
                // Fallback data
                const fallbackData = {
                    'Turkana': { potential: 'Low', class: 'low', points: '2150', functional: '35%', desc: 'Precambrian basement rocks with limited groundwater storage.' },
                    'Marsabit': { potential: 'Very Low', class: 'very-low', points: '1850', functional: '28%', desc: 'Volcanic rocks with limited permeability. Water mainly in fracture zones.' },
                    'Garissa': { potential: 'Moderate', class: 'moderate', points: '2450', functional: '45%', desc: 'Sedimentary formations with fair groundwater potential in specific zones.' },
                    'Wajir': { potential: 'Low', class: 'low', points: '1950', functional: '32%', desc: 'Limited rainfall and crystalline bedrock reduce groundwater availability.' },
                    'Mandera': { potential: 'Very Low', class: 'very-low', points: '1650', functional: '25%', desc: 'Extreme aridity and basement complex rocks limit groundwater development.' },
                    'Isiolo': { potential: 'Mod Low', class: 'moderate-low', points: '1750', functional: '38%', desc: 'Mixed geology with some sedimentary formations offering limited potential.' }
                };

                const data = fallbackData[countyName] || fallbackData['Turkana'];
                document.getElementById('modalCountyPotential').textContent = data.potential;
                document.getElementById('modalCountyPotential').className = `county-potential ${data.class}`;
                document.getElementById('modalCountyPoints').textContent = data.points;
                document.getElementById('modalCountyFunctional').textContent = data.functional;
                document.getElementById('modalCountyDesc').textContent = data.desc;
            }

            document.getElementById('countyModal').classList.add('active');
            document.body.style.overflow = 'hidden';
        }

        // Close county modal
        function closeCountyModal() {
            document.getElementById('countyModal').classList.remove('active');
            document.body.style.overflow = 'auto';
        }

        // Download county report
        function downloadCountyReport() {
            const countyName = document.getElementById('modalCountyTitle').textContent.replace(' County', '');
            showNotification(`Downloading ${countyName} report...`);

            // Create CSV content
            let csvContent = "County,Water Points,Functional,Non-Functional,Needs Repair,Functional Rate\n";

            if (HydrogeologyDashboard.countyStats?.[countyName]) {
                const stats = HydrogeologyDashboard.countyStats[countyName];
                const functionalRate = stats.total > 0 ?
                    Math.round((stats.functional / stats.total) * 100) : 0;

                csvContent += `"${countyName}",${stats.total},${stats.functional},${stats.nonFunctional},${stats.needsRepair},${functionalRate}%\n`;
            }

            // Create download link
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.setAttribute('href', url);
            link.setAttribute('download', `${countyName.toLowerCase()}_hydrogeology_report.csv`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);

            setTimeout(() => {
                showNotification('Report downloaded successfully');
                closeCountyModal();
            }, 1000);
        }

        // Map tab switching
        function switchMapLayer(layer) {
            const legendTitle = document.querySelector('.map-legend h5');
            const legendItems = document.querySelector('.legend-content');

            const layers = {
                groundwater: {
                    title: 'Groundwater Potential',
                    items: Object.entries(SuitabilityColors)
                        .filter(([key]) => key <= 5)
                        .map(([suitability, color]) => ({
                            color,
                            label: SuitabilityLabels[suitability] || 'Unknown'
                        }))
                },
                geology: {
                    title: 'Geological Formations',
                    items: [
                        { color: '#3498db', label: 'Quaternary' },
                        { color: '#2ecc71', label: 'Cretaceous' },
                        { color: '#f1c40f', label: 'Jurassic' },
                        { color: '#f39c12', label: 'Triassic' },
                        { color: '#e74c3c', label: 'Precambrian' }
                    ]
                },
                rainfall: {
                    title: 'Rainfall Distribution',
                    items: [
                        { color: '#3498db', label: 'High (800+ mm)' },
                        { color: '#2ecc71', label: 'Moderate' },
                        { color: '#f39c12', label: 'Low' },
                        { color: '#e74c3c', label: 'Very Low' }
                    ]
                },
                drainage: {
                    title: 'Drainage Density',
                    items: [
                        { color: '#3498db', label: 'Very Low' },
                        { color: '#2ecc71', label: 'Low' },
                        { color: '#f1c40f', label: 'Moderate' },
                        { color: '#f39c12', label: 'High' }
                    ]
                },
                landuse: {
                    title: 'Land Use',
                    items: [
                        { color: '#2ecc71', label: 'Forest' },
                        { color: '#f1c40f', label: 'Grassland' },
                        { color: '#f39c12', label: 'Agricultural' },
                        { color: '#e74c3c', label: 'Bare Land' }
                    ]
                }
            };

            const config = layers[layer] || layers.groundwater;
            legendTitle.textContent = config.title;

            const legendHtml = config.items.map(item => `
                <div class="legend-item">
                    <span class="legend-color" style="background: ${item.color};"></span>
                    <span>${item.label}</span>
                </div>
            `).join('');

            legendItems.innerHTML = legendHtml;

            // Update current layer
            HydrogeologyDashboard.currentLayer = layer;
            showNotification(`Map layer: ${config.title}`);
        }

        // Show notification
        function showNotification(message) {
            // Remove existing notification
            const existing = document.querySelector('.notification');
            if (existing) existing.remove();

            const notification = document.createElement('div');
            notification.className = 'notification';
            notification.style.cssText = `
                position: fixed;
                top: var(--space-4);
                right: var(--space-4);
                padding: var(--space-3) var(--space-4);
                background: var(--secondary);
                color: white;
                border-radius: var(--radius);
                font-size: var(--font-sm);
                z-index: 10001;
                animation: slideIn 0.3s ease;
                max-width: 280px;
                box-shadow: var(--shadow-md);
                display: flex;
                align-items: center;
                gap: var(--space-3);
            `;

            notification.innerHTML = `
                <i class="fas fa-info-circle"></i>
                <span>${message}</span>
            `;

            document.body.appendChild(notification);

            // Add animation if not present
            if (!document.querySelector('#notification-styles')) {
                const style = document.createElement('style');
                style.id = 'notification-styles';
                style.textContent = `
                    @keyframes slideIn {
                        from { transform: translateX(100%); opacity: 0; }
                        to { transform: translateX(0); opacity: 1; }
                    }
                    @keyframes slideOut {
                        from { transform: translateX(0); opacity: 1; }
                        to { transform: translateX(100%); opacity: 0; }
                    }
                `;
                document.head.appendChild(style);
            }

            setTimeout(() => {
                notification.style.animation = 'slideOut 0.3s ease';
                setTimeout(() => notification.remove(), 300);
            }, 3000);
        }

        // Update sidebar statistics
        function updateSidebarStats() {
            const stats = HydrogeologyDashboard.suitabilityStats;
            const highPotential = stats?.byClass?.[5]?.percentage || 15;

            document.getElementById('sidebar-suitability').textContent = '7';
            document.getElementById('sidebar-high-potential').textContent = `${highPotential}%`;
            document.getElementById('sidebar-layers').textContent = '7';

            // Update last updated time
            const now = new Date();
            document.getElementById('last-updated').textContent =
                now.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
        }

        // Update loading text
        function updateLoadingText(text) {
            const loadingText = document.getElementById('map-loading')?.querySelector('.loading-text');
            if (loadingText) {
                loadingText.textContent = text;
            }
        }

        // Show error
        function showError(message) {
            const mapContainer = document.querySelector('.map-container');
            mapContainer.innerHTML = `
                <div style="position: absolute; top: 0; left: 0; right: 0; bottom: 0; display: flex; flex-direction: column; align-items: center; justify-content: center; background: white; border-radius: var(--radius-lg);">
                    <i class="fas fa-exclamation-triangle" style="font-size: 48px; color: var(--danger); margin-bottom: var(--space-4);"></i>
                    <div style="font-size: var(--font-md); color: var(--gray); margin-bottom: var(--space-4); text-align: center;">
                        ${message}
                    </div>
                    <button class="btn btn-primary" onclick="location.reload()">
                        <i class="fas fa-redo"></i>
                        Reload Dashboard
                    </button>
                </div>
            `;
        }

        // Setup Event Listeners
        function setupEventListeners() {
            // Map tab switching
            document.querySelectorAll('.map-tab').forEach(tab => {
                tab.addEventListener('click', () => {
                    // Remove active class from all tabs
                    document.querySelectorAll('.map-tab').forEach(t => {
                        t.classList.remove('active');
                    });

                    // Add active class to clicked tab
                    tab.classList.add('active');

                    // Switch map layer
                    const layer = tab.dataset.layer;
                    switchMapLayer(layer);
                });
            });

            // Map controls
            document.getElementById('reset-view').addEventListener('click', () => {
                HydrogeologyDashboard.map.fitBounds(HydrogeologyDashboard.kenyaBounds);
            });

            document.getElementById('locate-me').addEventListener('click', locateUser);
            document.getElementById('export-map').addEventListener('click', exportMap);
            document.getElementById('fullscreen').addEventListener('click', toggleFullscreen);

            // Legend toggle
            document.getElementById('toggle-legend').addEventListener('click', toggleLegend);

            // Refresh button
            document.getElementById('refresh-data').addEventListener('click', () => {
                location.reload();
            });

            // Close modal on escape
            document.addEventListener('keydown', (e) => {
                if (e.key === 'Escape') closeCountyModal();
            });

            // Close modal on outside click
            document.getElementById('countyModal').addEventListener('click', (e) => {
                if (e.target === document.getElementById('countyModal')) {
                    closeCountyModal();
                }
            });
        }

        // Locate User
        function locateUser() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        const { latitude, longitude } = position.coords;
                        HydrogeologyDashboard.map.setView([latitude, longitude], 12);

                        L.marker([latitude, longitude])
                            .addTo(HydrogeologyDashboard.map)
                            .bindPopup('Your Location')
                            .openPopup();
                    },
                    (error) => {
                        showNotification('Unable to get your location. Please enable location services.');
                    }
                );
            } else {
                showNotification('Geolocation is not supported by your browser.');
            }
        }

        // Export Map
        function exportMap() {
            showNotification('Export feature would generate a high-resolution map image. In a production environment, this would use html2canvas for client-side export.');
        }

        // Toggle Fullscreen
        function toggleFullscreen() {
            const mapContainer = document.querySelector('.map-container');

            if (!document.fullscreenElement) {
                if (mapContainer.requestFullscreen) {
                    mapContainer.requestFullscreen();
                } else if (mapContainer.webkitRequestFullscreen) {
                    mapContainer.webkitRequestFullscreen();
                }
            } else {
                if (document.exitFullscreen) {
                    document.exitFullscreen();
                } else if (document.webkitExitFullscreen) {
                    document.webkitExitFullscreen();
                }
            }
        }

        // Toggle Legend
        function toggleLegend() {
            const legend = document.getElementById('map-legend');
            const toggleBtn = document.getElementById('toggle-legend');

            if (legend.style.display !== 'none') {
                legend.style.display = 'none';
                toggleBtn.textContent = 'Show';
            } else {
                legend.style.display = 'block';
                toggleBtn.textContent = 'Hide';
            }
        }

        // Handle Fullscreen Change
        document.addEventListener('fullscreenchange', handleFullscreenChange);
        document.addEventListener('webkitfullscreenchange', handleFullscreenChange);

        function handleFullscreenChange() {
            setTimeout(() => {
                HydrogeologyDashboard.map.invalidateSize();
            }, 100);
        }
    </script>
</body>

</html>